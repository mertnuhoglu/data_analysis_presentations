---
title: "Data Analysis Applications using R v1"
author: Mert Nuhoglu
date: July 16, 2015
output: ioslides_presentation
---

```{r load_packages, include=FALSE}
  source('test_data.R')
	dn = read_data_naming()
	data = generate_data %>%
		Map(dn$base_name, dn$seq_end) %>%
		setNames(dn$variable)
	
	# test data
	set.seed(1)
	n_kw = length(data$keyword)
	n_pg = length(data$page)
	kv = data.table(
		keyword = data$keyword %>% sample,
		visit = (runif(n_kw) * 100) %>% ceiling)
	kp = data.table(
		keyword = kv$keyword %>% sample_with_replace(n_pg),
		page = data$page %>% sample(n_pg))
	pc = data.table(
		page = kp$page %>% sample(n_pg),
		conversion = (runif(n_pg) * 0.05) %>% sample(n_pg) %>% round(3))

	# calculate conversion number for just a single keyword
	keyword = 'kw003'
	setkey(kv, keyword)
	visits = kv[keyword]$visit
	setkey(kp, keyword)
	page = kp[keyword]$page
	setkey(pc, page)
	conversion_rate = pc[page]$conversion
	conversions = visits * conversion_rate

	# calculate conversion numbers for all keywords
	r = kp %>%
		inner_join(pc, by="page") %>%
		inner_join(kv, by="keyword") %>%
		mutate( conversion_number = visit * conversion ) %>%
		group_by(keyword) %>%
		summarise(total_conversion = sum(conversion_number)) %>%
		select(keyword, total_conversion) %>%
		arrange(total_conversion) 
	
	r = r %>%
		arrange(desc(total_conversion))
	top_keywords = r$keyword[1:3]

	top_kp = kp %>%
		filter(keyword %in% top_keywords)
	# or filter using datatable subsetting (equivalent)
	setkey(kp, keyword)
	top_kp = kp[top_keywords]

	top_pages = top_kp$page
```

## Introduction

- Learning a language based on examples
	- Foreign language
	- Mind extracts the grammar rules by itself
		- Foreign language learning theory of Stephen Krashen:
			[http://www.sk.com.br/sk-krash-english.html](http://www.sk.com.br/sk-krash-english.html)
	  - Learning is more fun: balance between challenging - difficulty

<div class="notes">
Welcome everybody!

This presentation is a problem based tutorial for learning basics of data analysis using R.

In terms of teaching approach, this presentation has a somewhat different style. It prioritizes the examples more than the grammar rules. 

According to the foreign language learning theory of Stephen Krashen, mind extracts the grammar rules by itself. It captures the repeating patterns in the use of language. It discovers the grammar rules incrementally. 

This kind of language learning is much more fun and easier than learning a foreign language by learning grammar rules and memorizing words. 

I believe this natural learning approach is more appropriate in learning programming languages too. Therefore, I prepared this presentation in somewhat experimental style.

Please, give me your feedback on this learning approach.
</div>

## Ecommerce: Conversion rate optimization

- Ecommerce site: BallOrange.com 
- Conversion: Collecting the email addresses of visitors of the blog
- For all blog posts
	- Traffic varies
	- Conversion ratio varies
- The value of blog posts:
	- Traffic x conversion ratio
- Example:
	- Page A:
		- 1000 visitors x %5 conversion = 50 emails
	- Page B:
		- 500 visitors x %15 conversion = 75 emails

<div class="notes">
BallOrange.com is an ecommerce website. The web site contains a blog where articles about games are published. The blog is used for content marketing purposes. The aim is to receive email addresses of blog readers to keep them updated on new articles and campaigns. 

Making the anonymous visitors to leave their email addresses is very valuable for the BallOrange because this lets the company to build a good brand image in the audience. The act of getting an email address of a blog reader is called as "conversion" in internet marketing. The goal of the company is to increase the conversion rate as much as possible.
</div>

## Conversion rate optimization 2

- Data collected from Google Analytics:

	- Keyword - Visit: The number of visits per search keyword 
	- Keyword - Page: To which blog page does a search keyword send the visitors
	- Page - Conversion Rate: Ratio of visitors that leave their email addresses in each page

<div class="notes">
To increase the conversion rate the company has setup Google Analytics service in their shopping cart web site. Assume that the company obtains the following datasets from analytics software:

- Keyword - Visit dataset which contains the number of visits per search keyword 
- Keyword - Page dataset which contains the mappings between keywords and the blog pages to which a search keyword sends the visitors
- Page - Conversion Rate dataset which contains the ratio of visitors that leave their email addresses for each page

The final goal of the company is to improve the total number of conversions. To achieve this, the company wants to find out which keywords and pages are most valuable in terms of the total number of conversions achieved.
</div>

# Test Data Generation

## Data model

- keyword-page: kp
- page-conversion: pc
- keyword-visit: kv

<div class="notes">
In this example, we assume that we have three datasets or tables as input. I am using the terms dataset and table as synonym words. A dataset or table is like a spreadsheet in Excel. You have multiple columns. Each column corresponds to a variable. Each row is a record or an observation.

So, we have three tables:

- keyword-page table denoted as kp
- page-conversion table denoted as pc
- keyword-visit table denoted as kv

</div>

## Generate test data

```{r }
head(kv)
head(kp)
```

<div class="notes">
I prepared some test data. In fact, I believe that producing test data rapidly is an important skill every data scientist should know. But for now, I won't explain how to produce test data. 

Here are some sample records from two tables: kv which is keyword-visit table and kp which is keyword-page table.
</div>

## Generate test data 2

```{r }
head(pc)
pc %>% head
```

<div class="notes">
And these are the sample records from page-conversion table.

Note that the above statement and below statement produce the same output.

The classical way of calling a function is the first one. head is a function. pc is the argument or input of the function. 

But R allows us to write the usual functions in a different way with the help of a library called as dplyr.

This is an operator. It is called as pipe operator. It works like a pipe. It pipes the first argument to the second argument. So, it pipes the table pc to the function head.
</div>

## sample function

```{r }
set.seed(1)
sample(1:10, 3)
set.seed(1)
1:10 %>% sample(3)
```

```{r }
sample(c("ali", "veli", "can", "cem"), 3)
```

## Test datatable 

```{r }
	kv = data.table(
		keyword = data$keyword %>% sample,
		visit = (runif(n_kw) * 100) %>% ceiling)
kv
```

## Random number generation

```{r }
runif(10)
```
 
```{r }
runif(10) * 100
```

## Generating test data - complete

```{r }
	dn = read_data_naming()
	data = generate_data %>%
		Map(dn$base_name, dn$seq_end) %>%
		setNames(dn$variable)
	
	set.seed(1)
	n_kw = length(data$keyword)
	kv = data.table(
		keyword = data$keyword %>% sample,
		visit = (runif(n_kw) * 100) %>% ceiling)
	kp = data.table(
		keyword = kv$keyword %>% sample,
		page = data$page %>% sample(n_kw))
	pc = data.table(
		page = kp$page %>% sample,
		conversion = (runif(n_kw) * 0.05) %>% sample(n_kw) %>% round(3))
```

# Conversion Problem

## Problem Definition

- Find 5 keywords that let us collect the most email addresses

## What is the conversion ratio for some keyword?

- How many visitors for keyword "kw003"?

```{r }
	keyword = 'kw003'
	setkey(kv, keyword)
	kv3 = kv[keyword]
  kv3
```

- Let's just get the visitors amount

```{r }
setkey(kv, keyword)
visits = kv[keyword]$visit
visits
```

## How much traffic does this keyword bring to which page?

```{r }
  setkey(kv, keyword)
	setkey(kp, keyword)
	kp3 = kv[keyword]
  kp3
	page = kp[keyword]$page
  page
```

## How much is the conversion ration of that page?

```{r }
setkey(pc, page)
pc3 = pc[page]
pc3
conversion_rate = pc3$conversion
conversion_rate
```

## What is the amount of total conversions (number of collected emails)?

```{r }
setkey(kv, keyword)
visits = kv[keyword]$visit
conversions = visits * conversion_rate
conversions
```

# General Solution to the Problem

## How to generalize this calculation for all keywords and pages?

1. Approach: Imperative approach
- Let's do the above calculation for each keyword
   - for loop of keywords
     - get the pages of that keyword
   - inner loop for pages
		 - get the conversion ration of the page
		 - multiply conversion ratios with visitors amounts
		 - sum up the conversion amounts for all the pages belonging to the same keyword

## Generalization of the calculation 2

2. Approach: Declarative approach
	 - Describe what to do instead of how to do it
	 - Sets and relationships
	 - SQL style
- SQL table = a mapping between n variables/sets
	- keyword-page: kp
	- page-conversion: pc
	- keyword-visit: kv

## Join operation

- Join the mappings/tables that have common variables/sets
- Example: 
   - keyword-page
   - keyword-visit
- Result:
   - keyword-page-visit

## Symbolic thinking

- Ignore how we are going to join
- Focus into what we will do
- Let's join the tables keyword-page and page-conversion
  - keyword-page-conversion
- Add page-visit table to that
  - keyword-page-conversion-visit

## Symbolic thinking

- conversion_number = conversion x visit
  - keyword-page-conversion-visit-conversion_number
- remove unnecessary variables:
  - keyword-conversion_number
- there are n rows for each keyword
	- group the rows that have the same keyword (pivoting/grouping)
	- sum conversion_number in each group: total_conversion
- order all the rows by total_conversion
- get the top 5

## Let's code this procedure

```{r }
	r = kp %>%
		inner_join(pc, by="page") %>%
		inner_join(kv, by="keyword") %>%
		mutate( conversion_number = visit * conversion ) %>%
		group_by(keyword) %>%
		summarise(total_conversion = sum(conversion_number)) %>%
		select(keyword, total_conversion) %>%
		arrange(total_conversion) 
r %>% head
```

## Reverse the ordering

```{r }
	r = r %>%
		arrange(desc(total_conversion))
r %>% head
```

## What pages are the targets of the best keywords?

- Get the best 3 keywords (filtering)
- What are the pages these keywords provide traffic?

```{r }
top_keywords = r$keyword[1:3]
top_kp = kp %>%
  filter(keyword %in% top_keywords)
top_kp %>% head
top_pages = top_kp$page
top_pages
```

# Final notes

## Functional programming in these codes?

- Functional sequence
  - Functional:
    - input: function
    - output: data (vector)
- Higher order functions
  - input: function
  - output: function
- There is no for loop 

## Links

- [Data Science Istanbul](https://www.facebook.com/groups/465842350233183/)
- [RStudio Webinars](http://www.rstudio.com/resources/webinars/)
- [Functional Programming Design Patterns](http://fsharpforfunandprofit.com/fppatterns/)
- [Brian Beckman: Don't fear the Monad](https://www.youtube.com/watch?v=ZhuHCtR3xq8)
- [The Lambda Calculus for Absolute Dummies (like myself)](http://palmstroem.blogspot.com.tr/2012/05/lambda-calculus-for-absolute-dummies.html)

## Presentation and codes

- Html5 slides: [http://mertnuhoglu.github.io/data_analysis_presentations/istanbulcoders/index.html](http://mertnuhoglu.github.io/data_analysis_presentations/istanbulcoders/index.html)
- Source codes: [https://github.com/mertnuhoglu/data_analysis_presentations/istanbulcoders](https://github.com/mertnuhoglu/data_analysis_presentations/istanbulcoders)
- Tools (PowerPoint killers): 
	- [slidify](http://ramnathv.github.io/slidify/)
  - [knitr](http://yihui.name/knitr/)
  - [RMarkdown](http://rmarkdown.rstudio.com/)


